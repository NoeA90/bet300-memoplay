<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BET300 ¬∑ MemoPlay</title>
<meta name="theme-color" content="#0b0f1e"/>
<style>
:root{
  --bg:#0b0f1e; --panel:#121634; --panel2:#0f1330; --border:#1e2150;
  --text:#e8ebff; --muted:#b7b9d6; --ok:#25D366;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;color:var(--text);background:var(--bg);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:
  radial-gradient(900px 500px at 50% -10%, rgba(101,74,255,.25), transparent),
  radial-gradient(700px 350px at 100% 0%, rgba(0,209,255,.18), transparent),
  linear-gradient(180deg,#0b0f1e 0%,#0b0f1e 60%,#0a0d20 100%);
}

/* Layout compacto mobile-first */
.container{max-width:980px;margin:10px auto;padding:0 10px calc(var(--dock-h,74px) + 10px)}
.card{background: radial-gradient(120% 100% at 50% 0%, rgba(124,77,255,.08), transparent), var(--panel2);
  border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 15px 40px rgba(0,0,0,.35)}
@media(min-width:560px){.card{padding:14px}}
@media(min-width:960px){.card{padding:18px}}

.head{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
.brand{height:26px;width:auto;filter:drop-shadow(0 2px 8px rgba(0,0,0,.4))}
.pill{background:linear-gradient(90deg,rgba(124,77,255,.15),rgba(0,209,255,.15));border:1px solid var(--border);
  border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
.pill.time{display:flex;gap:8px;align-items:center}
.pill.sound{cursor:pointer;user-select:none}
.count{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:rgba(255,204,0,.15);
  border:1px solid rgba(255,204,0,.35);color:#ffe27a;font-weight:700;font-variant-numeric:tabular-nums}
.head .spacer{flex:1 1 auto}

/* CTA arriba a la derecha */
.ctaTop{display:inline-flex;gap:10px;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;font-weight:800;
  background:linear-gradient(90deg,#ffd166,#ff7ab6);color:#0a0f20;box-shadow:0 8px 20px rgba(0,0,0,.25);text-decoration:none;white-space:nowrap}

/* grid compacto */
.grid{display:grid;gap:12px;grid-template-columns:minmax(0,1fr)}
@media(min-width:900px){.grid{grid-template-columns:1.15fr .85fr}}

.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
.center{text-align:center}
h1,h2,h3,p{margin:0 0 6px} h1{font-size:22px} .muted{color:var(--muted)}
@media(max-width:420px){h1{font-size:19px}}

.stat{display:flex;gap:10px;align-items:center;justify-content:center;margin:6px 0 8px}
.badge{min-width:68px;height:42px;border-radius:12px;background:radial-gradient(100% 100% at 50% 0%, rgba(0,209,255,.35), rgba(124,77,255,.35));
  display:grid;place-items:center;font-weight:800;font-size:16px;box-shadow:inset 0 0 10px rgba(124,77,255,.35)}
.smallline{font-size:12px;color:var(--muted)}

/* Dock inferior (compacto) */
.dock{
  --dock-h: 70px;
  position:fixed;left:0;right:0;bottom:0;z-index:10;
  background:linear-gradient(180deg, rgba(11,15,30,0) 0%, rgba(11,15,30,.85) 22%, rgba(11,15,30,.95) 100%);
  padding:8px 10px 12px;display:flex;gap:8px;align-items:center
}
.btn{appearance:none;border:none;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;background:linear-gradient(90deg,#6c59ff,#00d1ff);color:#0a0f20;width:100%;
  box-shadow:0 8px 20px rgba(0,0,0,.35)}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn.ok{background:#25D366;color:#0b0f1e}

/* ===== MEMOTEST (12 cartas, mobile primero) ===== */
.stage{display:flex;align-items:center;justify-content:center}
.memo{
  display:grid;gap:6px;
  grid-template-columns:repeat(3, minmax(70px,1fr));
  max-width:335px;margin:6px auto 0;min-height:268px;
}
@media(min-width:380px){.memo{grid-template-columns:repeat(3, minmax(80px,1fr));max-width:355px}}
@media(min-width:560px){.memo{grid-template-columns:repeat(4, minmax(90px,1fr));max-width:520px;gap:10px}}

.cardx{position:relative;aspect-ratio:3/4;border-radius:14px;background:#0f1330;
  border:1px solid var(--border);overflow:hidden;cursor:pointer;perspective:800px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
.flip{position:relative;width:100%;height:100%;transition:transform .35s ease;transform-style:preserve-3d}
.cardx.revealed .flip{transform:rotateY(180deg)}
.face{position:absolute;inset:0;display:grid;place-items:center;backface-visibility:hidden}
.front{background:linear-gradient(180deg,#11163a,#0c1230)}
.back{transform:rotateY(180deg);background:radial-gradient(120% 100% at 50% 0%, rgba(124,77,255,.10), transparent), #0c1230}
.face canvas{display:block;width:100%;height:100%}

/* Confetti */
.confetti{position:fixed;inset:0;pointer-events:none;z-index:40}
.confetti i{position:absolute;top:-20px;width:10px;height:14px;border-radius:2px;opacity:0;animation:confFall 1.6s linear forwards}
@keyframes confFall{8%{opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}

/* ===== MODAL ===== */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,8,18,.65);backdrop-filter:blur(2px);z-index:60}
.modal.show{display:flex}
.modal .box{width:min(520px,92vw);background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
.modal h2{margin:0 0 8px}
.row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.meta{margin:10px 0 14px;color:var(--muted);font-size:14px}
.code{font-weight:800;letter-spacing:.5px;color:#ffe27a}
.modal .actions{display:flex;gap:10px;margin-top:10px}
.modal .ghost{background:#182040;color:var(--text)}
</style>
</head>
<body>

<!-- papelitos -->
<div id="confetti" class="confetti" aria-hidden="true"></div>

<!-- MODAL PREMIO -->
<div id="prizeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="box">
    <div class="row">
      <h2 id="mTitle">üéâ ¬°Premio obtenido! Hace Captura!</h2>
      <button id="mClose" class="btn ghost" style="width:auto;padding:10px 12px">Cerrar</button>
    </div>
    <p id="mPrize" style="font-size:22px;font-weight:800;margin:6px 0 2px">-</p>
    <p id="mDesc" class="muted" style="margin:0 0 10px">-</p>
    <div class="meta">
      <div><b>C√≥digo:</b> <span id="mCode" class="code">‚Äî</span></div>
      <div><b>Fecha/hora:</b> <span id="mTs">‚Äî</span></div>
    </div>
    <div class="actions">
      <a id="mClaim" class="btn ok" style="text-align:center" target="_blank" rel="noopener">üì≤ Reclamar por WhatsApp</a>
      <a id="mPlatform" class="btn" style="text-align:center" target="_blank" rel="noopener">üéÆ Ir a la plataforma</a>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="head">
      <img class="brand" src="img/logo-bet300.svg" alt="BET300" onerror="this.outerHTML='<strong>BET300</strong>'">
      <span class="pill">Promo interactiva</span>
      <span class="pill time">‚ö° Tiempo limitado <span class="count" id="countdown">--:--</span></span>
      <span class="pill sound" id="soundToggle">üîä Sonido: <b id="soundState">ON</b></span>
      <span class="spacer"></span>
      <a id="playNow" class="ctaTop" target="_blank" rel="noopener">üéÆ Entrar a la plataforma</a>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="center" style="margin-bottom:4px">
          <h1 id="title">MemoPlay</h1>
        </div>
        <div class="stage">
          <div id="memo" class="memo"></div>
        </div>
      </div>

      <div class="panel">
        <div class="center">
          <div class="stat">
            <div>
              <div class="badge" id="badge">-</div>
              <div class="smallline" id="stampLine" aria-live="polite"></div>
            </div>
            <div>
              <h1 id="statusTitle">Ten√©s 1 chance hoy</h1>
              <p class="muted" id="statusSub">Los premios se acreditan con tu <b>pr√≥xima carga</b>.</p>
            </div>
          </div>
        </div>
        <!-- ya no hay bloque de promo aqu√≠ -->
      </div>
    </div>
  </div>
</div>

<!-- Dock fijo -->
<div class="dock">
  <button id="retryBtn" class="btn" disabled>üîÅ Volver a intentar</button>
  <button id="claimBtn" class="btn ok" disabled>üì≤ Reclamar</button>
</div>

<script>
/* ===== Premios ===== */
const HIGH_PRIZES=[{type:'money',value:5000},{type:'money',value:4000},{type:'percent',value:20},{type:'percent',value:15}];
const BASE_PRIZES=[{type:'money',value:2000},{type:'money',value:1000},{type:'percent',value:10}];
const money=n=>"$"+n.toLocaleString("es-AR");
const label=p=>p.type==='money'?money(p.value):(`${p.value}%`);
const describe=p=>p.type==='money'?`Recib√≠s <b>${money(p.value)} extra</b> con tu pr√≥xima carga.`:`Recib√≠s un <b>${p.value}% extra</b> con tu pr√≥xima carga.`;

/* ===== WhatsApp / plataforma (3 PCs como ruleta original) ===== */
const WP_NUMBERS={principal:"5491134970581",pc1:"5491171328828",pc2:"5491155959790",pc3:"5491157736200"};
const PLATFORM_LINKS={principal:"https://plataforma.example/inicio",pc1:"https://c01.bet300vip.com/",pc2:"https://c02.bet300vip.com/",pc3:"https://c03.bet300vip.com/"};
const params=new URLSearchParams(location.search);const pc=params.get('pc');
let WP=WP_NUMBERS.principal, PLATFORM=PLATFORM_LINKS.principal;
if(pc==='1'){WP=WP_NUMBERS.pc1;PLATFORM=PLATFORM_LINKS.pc1}
if(pc==='2'){WP=WP_NUMBERS.pc2;PLATFORM=PLATFORM_LINKS.pc2}
if(pc==='3'){WP=WP_NUMBERS.pc3;PLATFORM=PLATFORM_LINKS.pc3}
document.getElementById('playNow').href=PLATFORM;

/* ===== Antifraude / WhatsApp ===== */
const SALT="bet300-memotest-v1";
function ensureDeviceId(){let id=localStorage.getItem('device_id');if(!id){id=(crypto.randomUUID?.()||`${Date.now()}-${Math.random().toString(36).slice(2,8)}`);localStorage.setItem('device_id',id);}return id;}
const DEVICE_ID=ensureDeviceId();
function todayKey(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`}
function tsString(d=new Date()){const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');return `${dd}/${mm}/${yyyy} ${hh}:${mi}`}
async function sha256hex(msg){const enc=new TextEncoder().encode(msg);const buf=await crypto.subtle.digest("SHA-256",enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("")}
async function makeClaimCode(prizeLabel){const base=`${DEVICE_ID}|${todayKey()}|${prizeLabel}|pc:${pc||'0'}|${SALT}`;const hex=await sha256hex(base);return hex.slice(0,10).toUpperCase()}
function whatsappText(prizeLabel){const code=localStorage.getItem('memo_code')||'(SIN-COD)';const ts=localStorage.getItem('memo_ts')||tsString();return `Hola, gan√© ${prizeLabel} en el memotest y quiero reclamarlo con mi pr√≥xima carga. C√≥digo: ${code} ¬∑ ${ts}`}

/* ===== Audio ===== */
let soundOn=true;const soundToggle=document.getElementById('soundToggle');const soundState=document.getElementById('soundState');
const AudioKit=(()=>{const Ctx=window.AudioContext||window.webkitAudioContext;const ctx=new Ctx();let unlocked=false;
  function unlock(){if(!unlocked){ctx.resume().catch(()=>{});unlocked=true;}}
  function fx(freq=880,dur=.08,vol=.09){const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=freq;g.gain.value=0;o.connect(g).connect(ctx.destination);const t=ctx.currentTime;g.gain.linearRampToValueAtTime(vol,t+.005);g.gain.exponentialRampToValueAtTime(.0001,t+dur);o.start(t);o.stop(t+dur)}
  function good(){[660,880,1320].forEach((f,i)=>setTimeout(()=>fx(f,.12,.12),i*120))}
  function flip(){fx(520,.06,.06)}
  return {unlock,good,flip};
})();
soundToggle.addEventListener('click',()=>{soundOn=!soundOn;soundState.textContent=soundOn?'ON':'OFF'});

/* ===== Countdown ===== */
const countdownEl=document.getElementById('countdown');
function endOfDay(){const n=new Date();const end=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,0,0).getTime();return end>Date.now()?end:new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,23,59,0,0).getTime()}
function tickCountdown(){const ms=endOfDay()-Date.now();const total=Math.max(0,Math.floor(ms/1000));const h=Math.floor(total/3600),m=Math.floor((total%3600)/60),s=total%60;countdownEl.textContent=h>0?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
setInterval(tickCountdown,1000);

/* ===== Confetti ===== */
const confetti=document.getElementById('confetti');
function confettiBurst(){confetti.innerHTML='';for(let i=0;i<28;i++){const p=document.createElement('i');p.style.left=(Math.random()*100)+'vw';p.style.animationDelay=(Math.random()*0.5)+'s';p.style.background=Math.random()<.5?'linear-gradient(#80ffea,#4e9cff)':'linear-gradient(#ffd166,#ff3d7f)';confetti.appendChild(p)}setTimeout(()=>confetti.innerHTML='',1800)}

/* ===== Canvas utils ===== */
function fitCanvas(canvas){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width  = Math.max(1, Math.round(rect.width * dpr));
  canvas.height = Math.max(1, Math.round(rect.height * dpr));
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx,w:rect.width,h:rect.height};
}
function drawFront(c){
  const {ctx,w,h} = fitCanvas(c);
  const grad = ctx.createLinearGradient(0,0,w,h);
  grad.addColorStop(0,'#8aaeff'); grad.addColorStop(0.45,'#9cf'); grad.addColorStop(1,'#ff93c5');
  ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);
  ctx.save(); ctx.translate(w/2,h/2); ctx.rotate(-Math.PI/8);
  ctx.fillStyle='rgba(255,255,255,.14)'; const W=w*1.6, H=h*1.6;
  for(let x=-W; x<W; x+=14){ ctx.fillRect(x,-H,8,H*2); }
  ctx.restore();
  ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.lineWidth=3; ctx.strokeRect(6,6,w-12,h-12);
  const qSize = Math.max(26, Math.min(56, Math.floor(w*0.45)));
  ctx.fillStyle='#0b0f1e'; ctx.font=`800 ${qSize}px system-ui,Segoe UI`; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('?', w/2, h*0.48);
}
function drawSymbol(c,type){
  const {ctx,w,h} = fitCanvas(c);
  ctx.fillStyle = '#0c1230'; ctx.fillRect(0,0,w,h);
  const bg = ctx.createRadialGradient(w/2,h*0.2,8,w/2,h*0.2,Math.max(w,h));
  bg.addColorStop(0,'rgba(124,77,255,.18)'); bg.addColorStop(1,'transparent');
  ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);
  ctx.save(); ctx.translate(w/2,h/2);
  switch(type){
    case 'seven': {
      const s = Math.min(w,h)*0.34;
      ctx.lineWidth = Math.max(10, s*0.28);
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#ffd166';
      ctx.beginPath(); ctx.moveTo(-s*1.1,-s*0.9); ctx.lineTo( s*1.1,-s*0.9); ctx.lineTo( 0, s*1.0); ctx.stroke();
      ctx.globalAlpha = .35; ctx.strokeStyle = '#fff'; ctx.lineWidth *= .45; ctx.stroke(); ctx.globalAlpha = 1; break;
    }
    case 'bell': {
      ctx.fillStyle = '#ffcc66';
      ctx.beginPath();
      const R = Math.min(w,h)*0.36;
      ctx.moveTo(-R*0.9, 0);
      ctx.quadraticCurveTo(-R*0.75,-R*0.9, 0,-R*0.95);
      ctx.quadraticCurveTo( R*0.75,-R*0.9, R*0.9, 0);
      ctx.quadraticCurveTo( R*0.6, R*0.55, 0, R*0.65);
      ctx.quadraticCurveTo(-R*0.6, R*0.55, -R*0.9, 0);
      ctx.closePath(); ctx.fill();
      ctx.fillStyle = '#ff9a3d'; ctx.beginPath(); ctx.arc(0,R*0.6,R*0.14,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=.25; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.ellipse(-R*0.35,-R*0.45,R*0.22,R*0.12, -0.6, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1; break;
    }
    case 'diamond': {
      ctx.fillStyle = '#7ae0ff';
      ctx.beginPath(); ctx.moveTo(0,-h*0.30); ctx.lineTo(w*0.24,-h*0.02); ctx.lineTo(0,h*0.30); ctx.lineTo(-w*0.24,-h*0.02);
      ctx.closePath(); ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(-w*0.24,-h*0.02); ctx.lineTo(0,-h*0.30); ctx.lineTo(w*0.24,-h*0.02);
      ctx.moveTo(-w*0.12,-h*0.02); ctx.lineTo(0,h*0.20); ctx.lineTo(w*0.12,-h*0.02);
      ctx.stroke(); break;
    }
    case 'cherry': {
      const R = Math.min(w,h)*0.13;
      ctx.fillStyle = '#ff4f6d';
      ctx.beginPath(); ctx.arc(-w*0.14,h*0.05,R,0,Math.PI*2);
      ctx.arc( w*0.14,h*0.05,R,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#6ddc6d'; ctx.lineWidth = 6;
      ctx.beginPath(); ctx.moveTo(-w*0.14,h*0.05);
      ctx.quadraticCurveTo(-w*0.05,-h*0.24, 0,-h*0.28);
      ctx.quadraticCurveTo( w*0.05,-h*0.24, w*0.14,h*0.05);
      ctx.stroke(); break;
    }
    case 'horseshoe': {
      const R = Math.min(w,h)*0.32;
      ctx.lineWidth = Math.max(8,R*0.22);
      ctx.strokeStyle = '#d1d5ff';
      ctx.beginPath(); ctx.arc(0, -R*0.05, R*0.75, Math.PI*0.2, Math.PI*0.8, false); ctx.stroke();
      ctx.fillStyle='#a5b4ff';
      const pts = [-0.55,-0.25,0,0.25,0.55];
      pts.forEach(px=>{ctx.beginPath();ctx.arc(px*R*0.75, -R*0.05 + R*0.50, R*0.06, 0, Math.PI*2);ctx.fill();});
      break;
    }
    case 'star': {
      ctx.fillStyle = '#ffe27a';
      const ro = Math.min(w,h)*0.30, ri = ro*0.45;
      ctx.beginPath();
      for(let i=0;i<10;i++){
        const r = i%2?ri:ro, a = -Math.PI/2 + i*Math.PI/5;
        const x = Math.cos(a)*r, y = Math.sin(a)*r;
        i?ctx.lineTo(x,y):ctx.moveTo(x,y);
      }
      ctx.closePath(); ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.stroke(); break;
    }
  }
  ctx.restore();
}

/* ===== Memotest ===== */
const memoEl=document.getElementById('memo');
const badge=document.getElementById('badge'), stampEl=document.getElementById('stampLine');
const statusTitle=document.getElementById('statusTitle'), statusSub=document.getElementById('statusSub');
const retryBtn=document.getElementById('retryBtn'), claimBtn=document.getElementById('claimBtn');

/* modal refs */
const modal=document.getElementById('prizeModal');
const mPrize=document.getElementById('mPrize');
const mDesc=document.getElementById('mDesc');
const mCode=document.getElementById('mCode');
const mTs=document.getElementById('mTs');
const mClaim=document.getElementById('mClaim');
const mPlatform=document.getElementById('mPlatform');
document.getElementById('mClose').onclick=()=>modal.classList.remove('show');
modal.addEventListener('click',e=>{ if(e.target===modal) modal.classList.remove('show') });
mPlatform.href = document.getElementById('playNow').href;

function openModal(prizeLabel, htmlDesc, code, ts, waUrl){
  mPrize.textContent = prizeLabel; mDesc.innerHTML = htmlDesc;
  mCode.textContent = code; mTs.textContent = ts; mClaim.href = waUrl;
  modal.classList.add('show');
}

const SYMBOL_TYPES=['seven','bell','diamond','cherry','horseshoe','star'];
let deck=[], open=[], tries=3, locked=false;

function cardTemplate(type, idx){
  return `
  <div class="cardx" data-idx="${idx}">
    <div class="flip">
      <div class="face front"><canvas id="f${idx}"></canvas></div>
      <div class="face back"><canvas id="b${idx}"></canvas></div>
    </div>
  </div>`;
}

function buildDeck(){
  const pairs = SYMBOL_TYPES.concat(SYMBOL_TYPES); // 12 cartas
  for(let i=pairs.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pairs[i],pairs[j]]=[pairs[j],pairs[i]]}
  deck = pairs.map((type,i)=>({type, id:i}));
  memoEl.innerHTML = deck.map((c,i)=>cardTemplate(c.type,i)).join('');
  requestAnimationFrame(()=>{ deck.forEach((c,i)=>{ drawFront(document.getElementById(`f${i}`)); drawSymbol(document.getElementById(`b${i}`), c.type); }); });
}

function attachHandlers(){
  memoEl.querySelectorAll('.cardx').forEach(el=>{
    el.addEventListener('click',()=>{
      if(locked || el.classList.contains('revealed') || localStorage.getItem('memo_done')==='1') return;
      if(soundOn) AudioKit.flip();
      el.classList.add('revealed'); open.push(el);
      if(open.length===2){
        locked=true;
        const [a,b]=open; const ai=deck[+a.dataset.idx], bi=deck[+b.dataset.idx];
        setTimeout(()=>{
          if(ai.type===bi.type){ finishGame(true); }
          else { a.classList.remove('revealed'); b.classList.remove('revealed'); tries--; if(tries===0){ finishGame(false); } }
          open=[]; locked=false;
        }, 520);
      }
    });
  });
}

/* Redibujar en resize/rotaci√≥n para mantener nitidez */
addEventListener('resize', ()=> {
  deck.forEach((c,i)=>{
    const f=document.getElementById(`f${i}`), b=document.getElementById(`b${i}`);
    if(f&&b){ drawFront(f); drawSymbol(b,c.type); }
  });
});

/* Persistencia diaria */
function restoreDaily(){
  const today=todayKey(); const stored=localStorage.getItem('memo_date');
  if(stored && stored!==today){
    ["memo_done","memo_prize","memo_code","memo_ts"].forEach(k=>localStorage.removeItem(k));
    localStorage.setItem('memo_date', today);
  } else if(!stored){ localStorage.setItem('memo_date', today) }
}
function restoreIfAny(){
  const done=localStorage.getItem('memo_done')==='1';
  if(!done) return;
  const p=JSON.parse(localStorage.getItem('memo_prize')||'null');
  const code=localStorage.getItem('memo_code')||'‚Äî';
  const ts=localStorage.getItem('memo_ts')||tsString();
  if(p){
    const prizeLabel=label(p);
    badge.textContent = prizeLabel;
    statusTitle.textContent = "üéâ ¬°Premio obtenido!";
    statusSub.innerHTML = describe(p);
    stampEl.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;
    const msg=whatsappText(prizeLabel);
    claimBtn.disabled=false;
    const waURL=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
    claimBtn.onclick=()=>location.href=waURL;
    // permitir abrir modal tocando la badge
    badge.parentElement.addEventListener('click',()=>openModal(prizeLabel, describe(p), code, ts, waURL));
  }
  retryBtn.disabled = true;
}

/* Final */
async function finishGame(win){
  const pool = win ? HIGH_PRIZES : BASE_PRIZES;
  const prize = pool[Math.floor(Math.random()*pool.length)];
  const prizeLabel = label(prize);

  const code = await makeClaimCode(prizeLabel);
  const ts   = tsString(new Date());
  localStorage.setItem('memo_code', code);
  localStorage.setItem('memo_ts', ts);
  localStorage.setItem('memo_done', '1');
  localStorage.setItem('memo_prize', JSON.stringify(prize));

  badge.textContent = prizeLabel;
  statusTitle.textContent = "üéâ ¬°Premio obtenido!";
  statusSub.innerHTML = describe(prize);
  stampEl.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;

  retryBtn.disabled = true; claimBtn.disabled = false;
  const msg = whatsappText(prizeLabel);
  const waURL = `https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
  claimBtn.onclick = ()=>location.href=waURL;

  confettiBurst(); if(soundOn) AudioKit.good();
  openModal(prizeLabel, describe(prize), code, ts, waURL);
}

/* Retry */
document.getElementById('retryBtn').addEventListener('click', ()=>{
  if(localStorage.getItem('memo_done')==='1') return;
  memoEl.innerHTML=''; open=[]; tries=3; buildDeck(); attachHandlers();
});

/* Helpers existentes de ruleta */
function todayKey(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`}

/* Init */
function init(){
  restoreDaily(); restoreIfAny(); buildDeck(); attachHandlers(); tickCountdown();
  document.addEventListener('click',()=>AudioKit.unlock(),{once:true});
  document.getElementById('retryBtn').disabled = localStorage.getItem('memo_done')==='1';
}
init();
</script>
</body>
</html>
